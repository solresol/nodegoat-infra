<VirtualHost *:80>
    ServerName ${NODEGOAT_DOMAIN}
    ServerAlias ${NODEGOAT_CMS_DOMAIN}

    DocumentRoot /var/1100CC/APP

    <Directory /var/1100CC/APP>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Enable rewrite engine
        RewriteEngine On

        # 1100CC routing - route all requests through index.php
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php/$1 [L,QSA]
    </Directory>

    # Deny access to sensitive directories
    <DirectoryMatch "^/var/1100CC/APP/(SETTINGS|CORE)/">
        Require all denied
    </DirectoryMatch>

    # Allow access to storage for uploaded files
    <Directory /var/1100CC/APP/STORAGE>
        Options -Indexes
        Require all granted
    </Directory>

    # Security headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"

    # Enable compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
    </IfModule>

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/nodegoat-error.log
    CustomLog ${APACHE_LOG_DIR}/nodegoat-access.log combined

    # PHP settings via Apache
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>
</VirtualHost>

# CMS VirtualHost (optional - for separate CMS subdomain)
<VirtualHost *:80>
    ServerName cms.${NODEGOAT_DOMAIN}

    DocumentRoot /var/1100CC/APP

    <Directory /var/1100CC/APP>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        RewriteEngine On
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule ^(.*)$ index.php/$1 [L,QSA]
    </Directory>

    <DirectoryMatch "^/var/1100CC/APP/(SETTINGS|CORE)/">
        Require all denied
    </DirectoryMatch>

    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"

    ErrorLog ${APACHE_LOG_DIR}/nodegoat-cms-error.log
    CustomLog ${APACHE_LOG_DIR}/nodegoat-cms-access.log combined
</VirtualHost>
